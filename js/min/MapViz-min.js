function getNiceDate(e){var t=d3.time.format("%Y-%m-%dT%H:%M:%S").parse;return e=t(e),foo=d3.time.format("%d %b %Y"),foo(e),foo(e)}var MapViz={geoData:null,crimeData:null,mapselector:".map",legendselector:".maplegend",colorScale:null,features:null,svg:null,legendsvg:null,zoom:null,projection:null,width:null,height:null,legendwidth:null,legendheight:null,stadium:null,stadium_x:null,stadium_y:null,stadium_width:20,stadium_height:30,crimes:null,crime_r:2,crimeColorScheme:null,draw:function(e,t){this.geoData=e,this.crimeData=t;var a=700,i=800;this.width=800,this.height=600;var r=d3.geo.mercator().scale(77e4).center([-122.3320313,47.59514]).translate([a/2,i/2]);this.projection=r;var l=d3.geo.path().projection(this.projection);d3.select(this.mapselector).selectAll("svg").remove(),this.svg=null;var s=d3.select(this.mapselector).append("svg").attr("width",a).attr("height",i);this.svg=s,features=s.append("g").attr("class","features"),this.features=features,features.selectAll("path").data(topojson.feature(this.geoData,this.geoData.objects.neighborhoods).features).enter().append("path").attr("d",l).on("click",this.clicked);var o=r([-122.3320313,47.59514]),c=o[0];this.stadium_x=c;var n=o[1];this.stadium_y=n;var h=20;this.stadium_width=h;var m=30;this.stadium_height=m;var d=s.append("g").append("rect").style("fill","green").attr("width",h).attr("height",m).attr("x",c-h).attr("y",n-m);this.stadium=d;var p=d3.behavior.zoom().scaleExtent([1,1/0]).on("zoom",this.zoomed);this.zoom=p,s.call(p),this.createCrimeColorScheme(),this.displayCrimes(),this.displayLegend(),$("svg circle").tipsy({gravity:"w",html:!0,title:function(){var e=this.__data__;return"Crime type: "+e.event_clearance_subgroup+"<br> Description: "+e.event_clearance_description+"<br> Date: "+getNiceDate(e.event_clearance_date)}})},clicked:function(e,t){},displayCrimes:function(){var e=5,t=this.svg.append("g").attr("class","crimes");t.selectAll("circle").data(this.crimeData).enter().append("circle").attr("cx",function(e,t){return MapViz.projection([e.longitude,e.latitude])[0]}).attr("cy",function(e,t){return MapViz.projection([e.longitude,e.latitude])[1]}).attr("r",e).style("fill",this.colorCrime),this.crimes=t,this.crime_r=e},zoomed:function(){MapViz.features.attr("transform","translate("+MapViz.zoom.translate()+")scale("+MapViz.zoom.scale()+")").selectAll("path").style("stroke-width",1/MapViz.zoom.scale()+"px"),MapViz.stadium.attr("transform","translate("+MapViz.zoom.translate()+")scale("+MapViz.zoom.scale()+")").selectAll("rect").attr("x",MapViz.stadium_x/MapViz.zoom.scale()).attr("y",MapViz.stadium_y/MapViz.zoom.scale()).attr("height",MapViz.stadium_height/MapViz.zoom.scale()).attr("width",MapViz.stadium_width/MapViz.zoom.scale()),MapViz.crimes.attr("transform","translate("+MapViz.zoom.translate()+")scale("+MapViz.zoom.scale()+")").selectAll("circle").attr("r",MapViz.crime_r/MapViz.zoom.scale())},createCrimeColorScheme:function(){crimeList="RECKLESS BURNING;NOISE DISTURBANCE;HARBOR CALLS;ANIMAL COMPLAINTS;ASSAULTS;AUTO RECOVERIES;AUTO THEFTS;BURGLARY ALARMS (FALSE);CAR PROWL;CASUALTIES;COMMERCIAL BURGLARIES;DISTURBANCES;FRAUD CALLS;GUN CALLS;HAZARDS;LIQUOR VIOLATIONS;MENTAL CALL;MISCELLANEOUS MISDEMEANORS;NARCOTICS COMPLAINTS;NUISANCE, MISCHIEF COMPLAINTS;PANIC ALARMS (FALSE);PARKING VIOLATIONS;PARKS EXCLUSIONS;PERSONS - LOST, FOUND, MISSING;PROPERTY - MISSING, FOUND;PROPERTY DAMAGE;PROWLER;RESIDENTIAL BURGLARIES;ROBBERY;SEX OFFENSE (NO RAPE);SUSPICIOUS CIRCUMSTANCES;THEFT;THREATS, HARASSMENT;TRAFFIC RELATED CALLS;TRESPASS;VEHICLE ALARMS (FALSE);VICE CALLS;WARRANT CALLS;WEAPONS CALLS",crimeArray=crimeList.split(";");for(var e={},t=crimeArray.length-1;t>=0;t--)e[crimeArray[t]]=this.getRandomColor();this.crimeColorScheme=e},colorCrime:function(e,t){return e.event_clearance_subgroup in MapViz.crimeColorScheme?MapViz.crimeColorScheme[e.event_clearance_subgroup]:(console.log(e.event_clearance_subgroup),console.log("crime type not found in colorscheme"),"black")},getRandomColor:function(){for(var e="0123456789ABCDEF".split(""),t="#",a=0;6>a;a++)t+=e[Math.floor(16*Math.random())];return t},displayLegend:function(){var e=200,t=600;this.legendwidth=e,this.legendheight=t;var a=d3.select(MapViz.legendselector).append("svg").attr("width",e).attr("height",t);this.legendsvg=a;var i=a.append("g").attr("class","legend-items")}};